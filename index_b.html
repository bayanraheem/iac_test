<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IAC Relief System | Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¥ØºØ§Ø«Ø© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --iac-primary: #1b8f4c;
  --iac-dark: #0a4d29;
  --bg-color: #f0f4f3;
  --glass: rgba(255, 255, 255, 0.95);
  --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  --font-base: clamp(13px, 1.2vw, 16px);
}

* { box-sizing: border-box; }

body {
  font-family: 'Tajawal', sans-serif;
  margin: 0; padding: 0;
  background: var(--bg-color);
  color: #2c3e50;
  height: 100vh; width: 100vw;
  overflow: hidden;
  font-size: var(--font-base);
}

/* --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
#login-screen {
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--iac-dark), var(--iac-primary));
  position: relative;
  z-index: 1000;
}

.login-card {
  background: white;
  padding: 30px;
  border-radius: 25px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}

.login-card img { width: 80px; height: 80px; border-radius: 15px; margin-bottom: 10px; }

/* --- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ --- */
#welcome-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: #ffffff; 
  z-index: 2000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 20px;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- Sidebar Styles --- */
.sidebar {
  position: fixed;
  right: -280px;
  top: 0;
  width: 280px;
  height: 100%;
  background: var(--iac-dark);
  transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1500;
  padding-top: 20px;
  box-shadow: -5px 0 15px rgba(0,0,0,0.2);
}
.sidebar.active { right: 0; }

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  margin-bottom: 10px;
  text-align: center;
}

.sidebar-item {
  padding: 18px 25px;
  color: white;
  text-decoration: none;
  display: block;
  font-weight: 700;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  cursor: pointer;
  transition: 0.2s;
  text-align: right;
}
.sidebar-item:hover { background: var(--iac-primary); padding-right: 35px; }
/* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
#checkout-result-container {
  display: flex;
  flex-direction: column;
  align-items: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
  gap: 15px;
  width: 100%;
  padding: 10px 0;
}

/* ØªÙˆØ­ÙŠØ¯ Ø­Ø¬Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ */
.id-card-modern, .checkout-item-card {
  width: 90%; /* Ø¹Ø±Ø¶ Ù…ÙˆØ­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
  max-width: 500px;
  margin: 0 auto;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transform: none !important; /* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…ÙŠÙ„Ø§Ù† */
  transition: none !important;
  background: white;
  border: 1px solid #eee;
  box-sizing: border-box;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
.checkout-main-card {
  padding: 20px;
  text-align: center;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© */
.checkout-item-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-right: 6px solid #d32f2f; /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†Ù‚Øµ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± */
}
/* --- Header Bar --- */
.header-bar {
  background: white; 
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  padding: 10px 15px; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  position: sticky; 
  top: 0; 
  z-index: 100; 
  border-bottom: 4px solid var(--iac-primary);
}

.header-logo-container { 
  display: flex; 
  align-items: center; 
  gap: 15px; 
  flex-grow: 1; 
}
.header-bar .logo { width: 50px; height: 50px; border-radius: 10px; overflow: hidden; }
.header-bar .logo img { width: 100%; height: 100%; object-fit: cover; }

.header-titles { 
  display: flex; 
  flex-direction: column; 
  align-items: flex-start; 
  justify-content: center;
}
.header-title-ar { 
  color: var(--iac-primary); 
  font-size: clamp(16px, 4.5vw, 20px); /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠ */
  font-weight: 800; 
  line-height: 1;
}
.header-title-en { 
  color: var(--iac-dark); 
  font-size: 10px; 
  font-weight: 700; 
  opacity: 0.8;
  letter-spacing: 0.5px;
  margin-top: 4px;
}

.menu-toggle {
  background: var(--iac-primary);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  cursor: pointer;
  font-size: 20px;
  transition: 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* --- Content Sections --- */
.section-content { display: none; padding:20px; width: 100%; padding-bottom: 40px; }
.section-content.active { display: block; }


/* ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ */
@media (max-width: 480px) {
  .section-content {
    padding: 5px 8px;
  }
}

/* --- Main App Layout --- */
#main-app { display: none; flex-direction: column; height: 100vh; overflow-y: auto; }

.main-layout { display: flex; flex-direction: column; gap: 20px; padding: 4px; align-items: center; width: 100%; }
.panel { background: var(--glass); border-radius: 20px; display: flex; flex-direction: column; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.3); width: 98%; max-width: 1000px; overflow: hidden; }
.panel-header { padding: 12px; background: rgba(27, 143, 76, 0.1); font-weight: 800; color: var(--iac-dark); text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
.panel-body { padding: 15px; flex: 1; }

/* --- Item Rows & Status Cards --- */
.item-info-wrapper { display: flex; flex-direction: column; align-items: flex-start; text-align: right; }
.item-name-ar { display: block; font-weight: 700; font-size: 15px; color: var(--iac-dark); line-height: 1.2; }
.item-name-en { display: block; font-size: 11px; color: #95a5a6; font-weight: 500; line-height: 1.2; margin-top: 2px; }

.id-card-modern { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eee; }
.id-card-header { background: var(--iac-primary); color: white; padding: 12px; text-align: center; font-size: 14px; }
.id-card-body { padding: 20px; text-align: center; }
.beneficiary-name { font-size: 19px; font-weight: 800; color: var(--iac-dark); }
.id-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
.detail-item { background: #f8fcf9; padding: 8px; border-radius: 10px; text-align: center; }
.detail-label { font-size: 10px; color: #7f8c8d; display: block; }
.detail-value { font-weight: 800; color: #2c3e50; font-size: 14px; }

.item-row { display: flex; align-items: center; justify-content: space-between; background: white; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; border-right: 5px solid var(--iac-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
.item-qty-box { background: #eef7f2; color: var(--iac-primary); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; margin: 0 10px; }
.deliver-btn { background: var(--iac-primary); color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 12px; }

.btn-action { width: 100%; padding: 10px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; display: flex; flex-direction: column; align-items: center; }
.btn-search { background: var(--iac-primary); color: white; }
.btn-scan { background: #34495e; color: white; }
input { width: 100%; padding: 12px; border: 2px solid #d1dbd6; border-radius: 12px; font-family: 'Tajawal'; font-size: 15px; margin-top: 5px; }

/* --- General Query Result Cards --- */
.status-card {
  background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-right: 5px solid #ccc;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.status-card.delivered { border-right-color: #2ecc71; }
.status-card.pending { border-right-color: #f1c40f; }
.tag {
  display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 11px; margin: 3px;
  background: #f0f4f3; color: var(--iac-dark); font-weight: 600; border: 1px solid #dee2e6;
}

/* --- Common UI --- */
.id-card-modern { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eee; margin-bottom: 15px; width: 100%; }
.id-card-header { background: var(--iac-primary); color: white; padding: 10px; text-align: center; font-size: 13px; font-weight: 700; }
.id-card-body { padding: 15px; text-align: center; }
.beneficiary-name { font-size: 18px; font-weight: 800; color: var(--iac-dark); }
.id-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.detail-item { background: #f8fcf9; padding: 6px; border-radius: 10px; text-align: center; border: 1px solid #edf5f0; }
.detail-label { font-size: 9px; color: #7f8c8d; display: block; margin-bottom: 2px; }
.detail-value { font-weight: 800; color: #2c3e50; font-size: 13px; }

.btn-action { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.btn-search { background: var(--iac-primary); color: white; }
.btn-scan { background: #34495e; color: white; }
label { font-weight: 700; color: var(--iac-dark); font-size: 13px; margin-bottom: 5px; display: block; text-align: right; }
input { width: 100%; padding: 12px; border: 2px solid #d1dbd6; border-radius: 12px; font-family: 'Tajawal'; font-size: 15px; margin-bottom: 10px; text-align: center; }

/* Stats Widgets */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 95%; max-width: 600px; margin-bottom: 10px; }
.stat-card { background: white; padding: 10px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-bottom: 4px solid #ddd; }
.stat-val { display: block; font-size: 20px; font-weight: 800; color: var(--iac-dark); }
.stat-lbl { display: block; font-size: 9px; color: #7f8c8d; font-weight: 700; }

</style>
</head>
<body>

<div id="welcome-overlay">
  <div class="welcome-content">
    <img src="https://i.postimg.cc/BvLv7FDL/images.jpg" class="welcome-logo" style="width: 100px; border-radius: 20px;">
    <div id="welcome-msg" class="welcome-name" style="font-size: 22px; margin-top: 15px;"></div>
    <div id="quote-ar" style="font-size: 18px; font-weight: 700; color: var(--iac-dark); margin-top: 10px;"></div>
    <div id="quote-en" style="font-size: 14px; color: #7f8c8d; margin-bottom: 30px; font-style: italic;"></div>
    <button class="btn-action btn-search" onclick="startApp()" style="max-width: 250px;">
      Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ | Let's Start
    </button>
  </div>
</div>

<div id="login-screen">
  <div class="login-card">
    <img src="https://i.postimg.cc/BvLv7FDL/images.jpg" alt="Logo">
    <h2 style="margin:10px 0; color:var(--iac-dark)">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø°ÙƒÙŠ</h2>
    <p style="font-size:12px; color:#666; margin-bottom:20px">Smart Distribution System</p>
    
    <input type="password" id="passInput" placeholder="Password | ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    
    <button class="btn-action btn-search" onclick="login()">
        Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… (Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯)
        <span style="font-size: 10px; opacity: 0.8;">Login with Password</span>
    </button>

    <div style="margin: 15px 0; color: #ccc;">Ø£Ùˆ | OR</div>

    <button class="btn-action btn-scan" onclick="toggleLoginScanner()">
        Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ·ÙˆØ¹
        <span style="font-size: 10px; opacity: 0.8;">Scan Volunteer QR</span>
    </button>
    
    <div id="login-qr-reader" style="width: 100%; max-width: 300px; margin: 15px auto; display: none; border-radius: 15px; overflow: hidden;"></div>
    <p id="login-err" style="color:red; font-size:12px; margin-top:10px"></p>
  </div>
</div>

<div id="main-app">
  
  <div id="mySidebar" class="sidebar">
    <div class="sidebar-header">
       <button class="deliver-btn" onclick="toggleSidebar()" style="width:100%">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© | Close Ã—</button>
    </div>
    <div class="sidebar-item" onclick="switchSection('distribution-sec')">ğŸ“ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ… | Daily Distribution</div>
    <div class="sidebar-item" onclick="switchSection('query-sec')">ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø´Ø§Ù…Ù„ | General Inquiry</div>
    <div class="sidebar-item" onclick="switchSection('report-sec')">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… | Daily Report</div>
    <div class="sidebar-item" onclick="switchSection('global-stats-sec'); loadGlobalStats();">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¡ Ø¹Ø§Ù… | Global Analytics</div>
    <div class="sidebar-item" onclick="switchSection('checkout-sec')">âœ… ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø±ÙˆØ¬ | Final Checkout</div>
  </div>

  <div class="header-bar">
    <div class="header-logo-container">
      <div class="logo"><img src="https://i.postimg.cc/BvLv7FDL/images.jpg" alt="Logo"></div>
      <div class="header-titles">
        <div class="header-title-ar">Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¥ØºØ§Ø«Ø© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ© IAC</div>
        <div class="header-title-en">IAC INTERNATIONAL AID CHARITY</div>
      </div>
    </div>
    <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
  </div>

  <div class="main-layout">
    
    <div id="distribution-sec" class="section-content active">
        <div class="panel">
          <div class="panel-header">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù‚Ù‚ | Search & Verify</div>
          <div class="panel-body">
            <label>Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ… | Day Number</label>
            <input type="number" id="dayInput" placeholder="Ex: 1">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ | Beneficiary ID</label>
            <input type="text" id="idInput" placeholder="DAM00000">
            <button class="btn-action btn-search" onclick="search()">
              ğŸ” Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª | View Items
            </button>
            <button class="btn-action btn-scan" onclick="toggleScanner()">
              ğŸ“· Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ | Scan QR Code
            </button>
            <div id="reader" style="margin-top:10px; display:none; border-radius: 15px; overflow: hidden;"></div>
          </div>
        </div>

        <div class="panel" style="margin-top: 15px;">
          <div class="panel-header">Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ | Profile Info</div>
          <div id="beneficiary-result" class="panel-body">
             <div style="text-align:center; color:#999; padding:20px">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... | Waiting for data...</div>
          </div>
        </div>

        <div class="panel" style="margin-top: 15px;">
          <div class="panel-header">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ØµØµØ§Øª | Items Entitlement</div>
          <div id="items-result" class="panel-body">
             <div style="text-align:center; color:#999; padding:20px">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù‡Ù†Ø§ | Items will appear here</div>
          </div>
        </div>
    </div>

    <div id="query-sec" class="section-content">
      <div class="panel">
        <div class="panel-header">Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø´Ø§Ù…Ù„ | General Inquiry</div>
        <div class="panel-body">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ | Beneficiary ID</label>
          <input type="text" id="idQueryInput" placeholder="DAM00000">
          <button class="btn-action btn-search" onclick="generalQuery()">ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø´Ø§Ù…Ù„ | Inquiry</button>
          <button class="btn-action btn-scan" onclick="toggleQueryScanner()">ğŸ“· Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ | Scan QR</button>
          <div id="query-reader" style="margin-top:10px; display:none; border-radius: 15px; overflow: hidden;"></div>
        </div>
      </div>
      <div id="query-results-container" style="width: 100%; max-width: 600px; padding: 15px 0;"></div>
    </div>

    <div id="report-sec" class="section-content">
      <div class="panel">
        <div class="panel-header">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ | Daily Report</div>
        <div class="panel-body">
          <label>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ… | Enter Day Number</label>
          <input type="number" id="reportDayInput" placeholder="1">
          <button class="btn-action btn-search" onclick="loadDailyReport()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± | View Report</button>
        </div>
      </div>
      <div id="report-stats" class="stats-grid" style="display:none; margin-top: 15px;">
        <div class="stat-card" style="border-bottom-color: var(--iac-primary);">
          <span id="stat-total" class="stat-val">0</span>
          <span class="stat-lbl">Ø§Ù„ÙƒÙ„ÙŠ | Total</span>
        </div>
        <div class="stat-card" style="border-bottom-color: #2ecc71;">
          <span id="stat-rec" class="stat-val">0</span>
          <span class="stat-lbl">Ø§Ø³ØªÙ„Ù… | Received</span>
        </div>
        <div class="stat-card" style="border-bottom-color: #e74c3c;">
          <span id="stat-not" class="stat-val">0</span>
          <span class="stat-lbl">Ù…ØªØ¨Ù‚ÙŠ | Pending</span>
        </div>
      </div>
      <div id="report-list" style="width: 100%; max-width: 600px; margin-top: 15px;"></div>
    </div>

    <div id="global-stats-sec" class="section-content">
      <div class="panel">
        <div class="panel-header">Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ | Global Analytics</div>
        <div class="panel-body">
           <div style="text-align:center; font-size:12px; color:#7f8c8d; margin-bottom:15px;">Ù…Ù„Ø®Øµ ÙƒØ§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙŠØ§Ù… Ø§Ù„ØªÙˆØ²ÙŠØ¹ | Full Summary of All Distribution Days</div>
           <div id="global-main-stats" class="stats-grid">
              </div>
        </div>
      </div>
      
      <div id="global-days-list" style="width: 100%; max-width: 600px; margin-top: 20px;">
         </div>
    </div>

  </div>
  <div id="checkout-sec" class="section-content">
  <div class="panel">
    <div class="panel-header">ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ | Final Exit Check</div>
    <div class="panel-body">
      <label>Ù…Ø³Ø­ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ ID | Scan or Enter ID</label>
      <input type="text" id="checkoutIdInput" placeholder="DAM00000">
      <button class="btn-action btn-search" onclick="runFinalCheckout()">âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… | Verify All</button>
      <button class="btn-action btn-scan" onclick="toggleCheckoutScanner()">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ | Scan QR</button>
      <div id="checkout-reader" style="margin-top:10px; display:none; border-radius: 15px; overflow: hidden;"></div>
    </div>
  </div>
  <div id="checkout-result-container" style="width: 100%; max-width: 600px; margin-top: 15px;"></div>
  </div>

</div>

<script>
// Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨ (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø±Ø§Ø¨Ø·Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ)
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxc-bPRnSDnh4aTgX6y-8oErJMwvRf29oq9-cSiBrwKX5sQkSIqMnhNfqDzgT3pXKgSQg/exec";

const SYSTEM_PASS = "iac2026";
let html5QrCode, loginQrCode, queryQrCode, checkoutQrCode;
let scannerActive = false;

const translationMap = {
  'vegetables (eggplant)':'Ø®Ø¶Ø§Ø± (Ø¨Ø§Ø°Ù†Ø¬Ø§Ù†)', 'vegetables(tomato)':'Ø®Ø¶Ø§Ø± (Ø¨Ù†Ø¯ÙˆØ±Ø©)','vegetables( potato)':'Ø®Ø¶Ø§Ø± (Ø¨Ø·Ø§Ø·Ø§)',
  'rice': 'Ø£Ø±Ø²', 'sugar': 'Ø³ÙƒØ±', 'bulgur': 'Ø¨Ø±ØºÙ„', 'capillary': 'Ø´Ø¹ÙŠØ±ÙŠØ©',
  'red lentil': 'Ø¹Ø¯Ø³ Ø£Ø­Ù…Ø±', 'tea': 'Ø´Ø§ÙŠ', 'sunflower oil': 'Ø²ÙŠØª Ø¯ÙˆØ§Ø± Ø§Ù„Ø´Ù…Ø³',
  'flour': 'Ø·Ø­ÙŠÙ†', 'green lentils': 'Ø¹Ø¯Ø³ Ø£Ø®Ø¶Ø±', 'tomato pasta': 'Ø¯Ø¨Ø³ Ø¨Ù†Ø¯ÙˆØ±Ø©',
  'children sweets': 'Ø³ÙƒØ§ÙƒØ± Ø£Ø·ÙØ§Ù„', 'salt': 'Ù…Ù„Ø­', 'spaghetti': 'Ù…Ø¹ÙƒØ±ÙˆÙ†Ø©', 'dates': 'ØªÙ…Ø±'
};

function getArName(name) { return translationMap[name.toLowerCase()] || name; }
function getEnName(name) { return name.charAt(0).toUpperCase() + name.slice(1); }

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
async function callServer(action, params = {}) {
  const response = await fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action, ...params })
  });
  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Ø¥Ø¶Ø§ÙØ© mode: 'cors' Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡ÙˆØ§ Ù…Ø´Ø§ÙƒÙ„ CORS
  return await response.json();
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø© ---
function toggleSidebar() {
  document.getElementById("mySidebar").classList.toggle("active");
}

function switchSection(sectionId) {
  document.querySelectorAll('.section-content').forEach(sec => sec.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
  toggleSidebar();
  if (html5QrCode && html5QrCode.getState() === 2) html5QrCode.stop();
  if (queryQrCode && queryQrCode.getState() === 2) queryQrCode.stop();
  if (checkoutQrCode && checkoutQrCode.getState() === 2) checkoutQrCode.stop();
  document.getElementById('reader').style.display = 'none';
  document.getElementById('query-reader').style.display = 'none';
  document.getElementById('checkout-reader').style.display = 'none';
}

// --- ÙˆØ¸Ø§Ø¦Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
function login() {
  if(document.getElementById('passInput').value === SYSTEM_PASS) {
    showMainApp();
  } else {
    document.getElementById('login-err').innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø© | Incorrect Password";
  }
}

function toggleLoginScanner() {
  const readerDiv = document.getElementById('login-qr-reader');
  if(readerDiv.style.display === 'block') {
    if(loginQrCode) loginQrCode.stop();
    readerDiv.style.display = 'none';
    return;
  }
  readerDiv.style.display = 'block';
  loginQrCode = new Html5Qrcode("login-qr-reader");
  loginQrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 }, (text) => {
    loginQrCode.stop();
    readerDiv.style.display = 'none';
    processVolunteerLogin(text);
  }).catch(err => {
      document.getElementById('login-err').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ | Camera Error";
  });
}

async function processVolunteerLogin(scannedId) {
  document.getElementById('login-err').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚... Checking...";
  try {
    const res = await callServer('verifyVolunteer', { qrId: scannedId });
    if(res.status === "success") {
      showWelcome(res);
    } else {
      document.getElementById('login-err').innerText = "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ | Access Denied";
    }
  } catch (error) {
    document.getElementById('login-err').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
  }
}

function showWelcome(data) {
  document.getElementById('login-screen').style.display = 'none';
  const overlay = document.getElementById('welcome-overlay');
  overlay.style.display = 'flex';
  document.getElementById('welcome-msg').innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ <span style="color:var(--iac-dark)">${data.name}</span> âœ¨`;
  document.getElementById('quote-ar').innerText = data.quoteAr;
  document.getElementById('quote-en').innerText = data.quoteEn;
}

function startApp() {
  document.getElementById('welcome-overlay').style.display = 'none';
  document.getElementById('main-app').style.display = 'flex';
}

function showMainApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'flex';
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙˆØ²ÙŠØ¹ ---
async function search() {
  const id = document.getElementById('idInput').value;
  const day = document.getElementById('dayInput').value;
  if(!id || !day) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID ÙˆØ§Ù„ÙŠÙˆÙ… | Enter ID & Day");
  
  document.getElementById('beneficiary-result').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... | Loading...";
  document.getElementById('items-result').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©... | Fetching list...";

  try {
    const res = await callServer('getEntitlement', { id, day });
    renderResult(res);
  } catch (error) {
    document.getElementById('beneficiary-result').innerHTML = "<div style='color:red; text-align:center'>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>";
    document.getElementById('items-result').innerHTML = "";
  }
}

function renderResult(res) {
  const bContainer = document.getElementById('beneficiary-result');
  const iContainer = document.getElementById('items-result');
  if(!res || res.status === "not_found") {
    bContainer.innerHTML = "<div style='color:red; text-align:center'>âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | ID Not Found</div>";
    iContainer.innerHTML = "";
    return;
  }
  const isActive = (res.status === "success");
  bContainer.innerHTML = `
    <div class="id-card-modern">
      <div class="id-card-header">Ø¨Ø·Ø§Ù‚Ø© ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ | Beneficiary ID</div>
      <div class="id-card-body">
        <div class="beneficiary-name">${res.name}</div>
        <div class="id-details-grid">
          <div class="detail-item"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© | ID</span><span class="detail-value">${document.getElementById('idInput').value}</span></div>
          <div class="detail-item"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ± | Order</span><span class="detail-value">${res.order ? '#' + res.order : '-'}</span></div>
          <div class="detail-item"><span class="detail-label">Ø§Ù„ÙŠÙˆÙ… | Day</span><span class="detail-value">${res.day}</span></div>
          <div class="detail-item"><span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø© | Status</span><span class="detail-value" style="color:${isActive?'green':'red'}">${isActive?'ÙØ¹Ø§Ù„ | Active':'Ù…Ø¹Ù„Ù‚ | Inactive'}</span></div>
        </div>
      </div>
    </div>`;

  if(!isActive) {
    iContainer.innerHTML = `<div style="text-align:center; color:#e74c3c; padding:20px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®ØµØµØ§Øª Ø§Ù„ÙŠÙˆÙ… | No items today</div>`;
    return;
  }

  let itemsHtml="";
  for(const [name,info] of Object.entries(res.items)){
    let action = info.isDelivered ? "<span style='color:green; font-weight:800; font-size:12px'>âœ” ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… | Done</span>" : 
                 (info.qty > 0 ? `<button class='deliver-btn' onclick="deliverItem('${name}',${info.qty},${info.colIndex})">ØªØ³Ù„ÙŠÙ… | Give</button>` : "-");
    
    itemsHtml += `
      <div class="item-row">
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="item-qty-box">${info.qty || 0}</div>
          <div class="item-info-wrapper">
            <span class="item-name-ar">${getArName(name)}</span>
            <span class="item-name-en">${getEnName(name)}</span>
          </div>
        </div>
        <div style="min-width:100px; text-align:center">${action}</div>
      </div>`;
  }
  iContainer.innerHTML = itemsHtml;
}

async function deliverItem(name, qty, colIdx) {
  if(!confirm(`ØªØ£ÙƒÙŠØ¯ ØªØ³Ù„ÙŠÙ…: ${getArName(name)}ØŸ \n Confirm delivery of ${name}?`)) return;
  try {
    await callServer('saveDelivery', {
      id: document.getElementById('idInput').value,
      day: document.getElementById('dayInput').value,
      colIdx: colIdx,
      qty: qty
    });
    // Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø©
    search();
  } catch (error) {
    alert("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ³Ù„ÙŠÙ…");
  }
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø¹Ø§Ù… ---
async function loadGlobalStats() {
  const mainStatsDiv = document.getElementById('global-main-stats');
  const daysListDiv = document.getElementById('global-days-list');
  
  mainStatsDiv.innerHTML = "<div style='grid-column: span 3; padding:20px; text-align:center;'>â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…...<br>Fetching from Delivered logs...</div>";
  daysListDiv.innerHTML = "";

  try {
    const res = await callServer('getGlobalAnalytics');
    if(res.status === "success") {
       // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
       mainStatsDiv.innerHTML = `
        <div class="stat-card" style="border-bottom: 5px solid var(--iac-primary);">
          <span class="stat-val" style="color:var(--iac-dark);">${res.totalAll}</span>
          <span class="stat-lbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…<br>Grand Total</span>
        </div>
        <div class="stat-card" style="border-bottom: 5px solid #2ecc71;">
          <span class="stat-val" style="color:#2ecc71;">${res.totalRecAll}</span>
          <span class="stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†<br>Total Received</span>
        </div>
        <div class="stat-card" style="border-bottom: 5px solid #e74c3c;">
          <span class="stat-val" style="color:#e74c3c;">${res.totalNotRecAll}</span>
          <span class="stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ<br>Total Pending</span>
        </div>
       `;

       if(res.daysDetails.length === 0) {
          daysListDiv.innerHTML = "<div style='text-align:center; padding:20px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙˆØ±Ù‚Ø© Delivered</div>";
          return;
       }

       // Ø¹Ø±Ø¶ ÙƒØ±ÙˆØª Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
       let html = "";
       res.daysDetails.forEach(dayInfo => {
          html += `
          <div class="status-card" style="border-right: 8px solid var(--iac-primary); margin-bottom:12px; background:white; border-radius:15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
                <span style="font-weight:800; font-size:18px; color:var(--iac-dark);">Ø§Ù„ÙŠÙˆÙ… | Day ${dayInfo.day}</span>
                <span class="tag" style="background: var(--iac-primary); color: white; border:none; padding:4px 10px;">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${dayInfo.percent}%</span>
             </div>
             <div class="id-details-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div class="detail-item" style="background:#f8f9fa;"><span class="detail-label">Ø§Ù„ÙƒÙ„ÙŠ | Total</span><span class="detail-value">${dayInfo.total}</span></div>
                <div class="detail-item" style="background:#eefaf2;"><span class="detail-label">Ø§Ø³ØªÙ„Ù… | Rec.</span><span class="detail-value" style="color:#27ae60;">${dayInfo.received}</span></div>
                <div class="detail-item" style="background:#fff5f5;"><span class="detail-label">Ù…ØªØ¨Ù‚ÙŠ | Pend.</span><span class="detail-value" style="color:#e74c3c;">${dayInfo.pending}</span></div>
             </div>
          </div>`;
       });
       daysListDiv.innerHTML = html;
    } else {
       mainStatsDiv.innerHTML = "<div style='grid-column: span 3; color:red;'>" + res.message + "</div>";
    }
  } catch (error) {
    mainStatsDiv.innerHTML = "<div style='grid-column: span 3; color:red;'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>";
  }
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„ ---
async function generalQuery(scannedId) {
  const id = scannedId || document.getElementById('idQueryInput').value;
  if(!id) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID / Please enter ID");
  const container = document.getElementById('query-results-container');
  container.innerHTML = `<div style='text-align:center; padding:20px; color:var(--iac-dark);'>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... | Searching...</div>`;

  try {
    const res = await callServer('getGeneralStatus', { id });
    if(res.status === "success") {
      let html = `
        <div class="id-card-modern" style="border-right: 8px solid var(--iac-primary); margin-bottom:20px;">
          <div class="id-card-header">Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ | Beneficiary Profile</div>
          <div class="id-card-body">
            <div class="beneficiary-name">${res.name}</div>
            <div style="color: #7f8c8d; font-size: 14px; margin-top: 5px; font-weight:bold;">ID: ${res.id}</div>
          </div>
        </div>
      `;
      if (res.data.length > 0) {
        res.data.forEach(record => {
          const hasItems = record.deliveredItems.length > 0;
          html += `
            <div class="status-card ${hasItems ? 'delivered' : 'pending'}">
              <div style="display:flex; justify-content:space-between; align-items:center">
                <span style="font-weight:800; font-size:16px; color:var(--iac-dark)">Ø§Ù„ÙŠÙˆÙ… | Day: ${record.day}</span>
                <span style="font-size:11px; font-weight:700; color:${hasItems?'#1b8f4c':'#e67e22'}">
                  ${hasItems ? 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… | Received' : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… | Not Received'}
                </span>
              </div>
              <div style="margin-top:10px; border-top: 1px dashed #eee; padding-top:10px;">
                ${hasItems ? record.deliveredItems.map(name => `<span class="tag">${getArName(name)}</span>`).join('') : '<span style="color:#999; font-size:12px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª | No records</span>'}
              </div>
            </div>`;
        });
      } else {
        html += `<div style='text-align:center; background:white; padding:20px; border-radius:15px; color:#e74c3c;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø© | No records</div>`;
      }
      container.innerHTML = html;
    } else {
      container.innerHTML = `<div style='text-align:center; background:white; padding:20px; border-radius:15px; color:#e74c3c;'>âŒ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | Not Found</div>`;
    }
  } catch (error) {
    container.innerHTML = `<div style='text-align:center; color:red;'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>`;
  }
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ ---
async function loadDailyReport() {
  const day = document.getElementById('reportDayInput').value;
  if(!day) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ… | Please enter day");
  const listContainer = document.getElementById('report-list');
  const statsDiv = document.getElementById('report-stats');
  listContainer.innerHTML = "<div style='text-align:center; padding:20px;'>â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... | Processing...</div>";
  statsDiv.style.display = 'none';

  try {
    const res = await callServer('getDailyReport', { day });
    if(res.status === "success") {
      document.getElementById('stat-total').innerText = res.total;
      document.getElementById('stat-rec').innerText = res.received;
      document.getElementById('stat-not').innerText = res.notReceived;
      statsDiv.style.display = 'grid';
      if(res.list.length === 0) {
        listContainer.innerHTML = "<div class='status-card' style='text-align:center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø¬Ù„ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… | No data</div>";
        return;
      }
      let html = "";
      res.list.forEach(item => {
        const isRec = item.status;
        html += `
          <div class="status-card ${isRec ? 'delivered' : 'pending'}" style="padding: 12px; margin-bottom: 8px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="text-align:right">
                <div style="font-weight:800; color:var(--iac-dark); font-size:15px;">${item.name}</div>
                <div style="font-size:11px; color:#7f8c8d;">ID: ${item.id}</div>
              </div>
              <div>
                <span class="tag" style="background:${isRec?'#eef7f2':'#fff5f5'}; color:${isRec?'#1b8f4c':'#e74c3c'}; border:none; padding:5px 12px;">
                  ${isRec ? 'Ø§Ø³ØªÙ„Ù… | Received' : 'Ù„Ù… ÙŠØ³ØªÙ„Ù… | Pending'}
                </span>
              </div>
            </div>
          </div>`;
      });
      listContainer.innerHTML = html;
    }
  } catch (error) {
    listContainer.innerHTML = "<div style='text-align:center; color:red;'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>";
  }
}

// --- ÙˆØ¸Ø§Ø¦Ù ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø±ÙˆØ¬ ---
async function runFinalCheckout(scannedId) {
  const id = scannedId || document.getElementById('checkoutIdInput').value;
  if(!id) return;
  
  const container = document.getElementById('checkout-result-container');
  container.innerHTML = `
    <div style="text-align:center; padding:30px; color:#666;">
      â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...<br>
      Verifying records...
    </div>`;

  try {
    const res = await callServer('finalCheckoutVerify', { id });
    if(res.status === "success") {
      let statusColor = res.allGood ? "#1b8f4c" : "#d32f2f";
      
      // 1. Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¹Ø±Ù ÙˆØ§Ù„Ø­Ø§Ù„Ø©)
      let html = `
        <div class="id-card-modern checkout-main-card" style="border-top: 8px solid ${statusColor};">
            <div style="font-size: 40px; margin-bottom:10px;">${res.allGood ? 'âœ…' : 'âš ï¸'}</div>
            <div class="beneficiary-name" style="font-size:18px;">${res.name}</div>
            <div style="color: #7f8c8d; font-weight:bold; margin-bottom:15px;">ID: ${res.id}</div>
            
            <div style="padding:12px; border-radius:10px; background:${res.allGood ? '#eef7f2' : '#fff5f5'}; color:${statusColor};">
              <div style="font-weight:800;">
                ${res.allGood ? 'Ù…ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… - ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø®Ø±ÙˆØ¬' : 'ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù…Ù‡Ø§'}
              </div>
              <div style="font-size:12px; margin-top:4px;">
                ${res.allGood ? 'Full Delivery - Clear for Exit' : 'Missing Items - Please Check'}
              </div>
            </div>
        </div>
      `;

      // 2. Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Ø¨Ù†ÙØ³ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
      if (!res.allGood) {
        html += `
          <div style="width:90%; max-width:500px; font-weight:800; color:#444; margin-top:10px; text-align:right;">
             Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© | Remaining Items:
          </div>`;

        res.missingItems.forEach(item => {
          html += `
            <div class="checkout-item-card">
               <div class="item-info-wrapper">
                  <span class="item-name-ar" style="color:#d32f2f; font-size:15px;">${getArName(item.name)}</span>
                  <span class="item-name-en" style="font-size:11px; color:#999;">${getEnName(item.name)}</span>
               </div>
               <div style="text-align:left;">
                  <div style="font-size:10px; color:#7f8c8d;">Ø§Ù„Ù†Ù‚Øµ | Short:</div>
                  <div style="font-weight:800; color:#d32f2f; font-size:18px;">${item.required - item.received}</div>
               </div>
            </div>`;
        });
      }
      container.innerHTML = html;
    } else {
      // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„Ù„ØºØªÙŠÙ†
      container.innerHTML = `
        <div class="id-card-modern checkout-main-card" style="border-right: 6px solid #e74c3c;">
          <div style="color:#e74c3c; font-weight:800;">âŒ Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
          <div style="font-size:12px; color:#666; margin-top:5px;">Beneficiary ID not found in Delivered logs</div>
        </div>`;
    }
  } catch (error) {
    container.innerHTML = `<div style="text-align:center; color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>`;
  }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù‚Ø³Ù… Ø§Ù„Ø®Ø±ÙˆØ¬
function toggleCheckoutScanner() {
  const readerDiv = document.getElementById('checkout-reader');
  if(readerDiv.style.display === 'block') {
    if(checkoutQrCode) checkoutQrCode.stop();
    readerDiv.style.display = 'none';
    return;
  }
  readerDiv.style.display = 'block';
  checkoutQrCode = new Html5Qrcode("checkout-reader");
  checkoutQrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
    checkoutQrCode.stop();
    readerDiv.style.display = 'none';
    document.getElementById('checkoutIdInput').value = text;
    runFinalCheckout(text);
  }).catch(err => alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ØªØµÙØ­"));
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
async function toggleScanner() {
  const readerDiv = document.getElementById('reader');
  if (readerDiv.style.display === 'block') {
    if(html5QrCode) await html5QrCode.stop();
    readerDiv.style.display = 'none';
    return;
  }
  readerDiv.style.display = 'block';
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" }, 
    { fps: 10, qrbox: 250 },
    (text) => {
      document.getElementById('idInput').value = text;
      html5QrCode.stop();
      readerDiv.style.display = 'none';
      search(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­
    }
  ).catch(err => alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ØªØµÙØ­"));
}

function toggleQueryScanner() {
  const readerDiv = document.getElementById('query-reader');
  if(readerDiv.style.display === 'block') {
    if(queryQrCode) queryQrCode.stop();
    readerDiv.style.display = 'none';
    return;
  }
  readerDiv.style.display = 'block';
  queryQrCode = new Html5Qrcode("query-reader");
  queryQrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
    queryQrCode.stop();
    readerDiv.style.display = 'none';
    document.getElementById('idQueryInput').value = text;
    generalQuery(text);
  }).catch(err => alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ØªØµÙØ­"));
}

// Ø¯Ø§Ù„Ø© runSearch (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±) ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
function runSearch() {
  search();
}
</script>
</body>
</html>